<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OmniForge | Precision Performance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@500&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #000; color: #fff; margin: 0; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(20, 20, 23, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .neo-card { border-radius: 2.5rem; }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 3s linear infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        const { useState, useEffect } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyDCGa57RlWlZTvKBGmAL5NbjCfl4tKHbcw",
            authDomain: "gestordeportes-36ba3.firebaseapp.com",
            projectId: "gestordeportes-36ba3",
            storageBucket: "gestordeportes-36ba3.firebasestorage.app",
            messagingSenderId: "774570456776",
            appId: "1:774570456776:web:b0e1d2df541e0207aa97fd"
        };

        // Credenciales Strava
        const STRAVA_CLIENT_ID = "143834"; // Asegúrate de que este sea tu ID real
        const STRAVA_SECRET = "b6c84aa920c3173ceacd33b568b85c99b7c07bb7";
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [history, setHistory] = useState([]);
            const [status, setStatus] = useState(null);
            const [isSyncing, setIsSyncing] = useState(false);
            const [currentAccessToken, setCurrentAccessToken] = useState("06ee57d24b4323ae084f327d3760e683d7d02cfe");

            useEffect(() => {
                signInAnonymously(auth).catch(() => setStatus("Error: Habilita Auth Anónimo en Firebase"));
                return onAuthStateChanged(auth, setUser);
            }, []);

            useEffect(() => {
                if (!user) return;
                const path = collection(db, "artifacts", "gestordeportes-36ba3", "users", user.uid, "history");
                return onSnapshot(path, (snapshot) => {
                    const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    setHistory(data.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)));
                });
            }, [user]);

            const showStatus = (msg) => {
                setStatus(msg);
                setTimeout(() => setStatus(null), 5000);
            };

            // FUNCIÓN CLAVE: Renovación de Token
            const refreshAccessToken = async () => {
                try {
                    const response = await fetch('https://www.strava.com/oauth/token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            client_id: STRAVA_CLIENT_ID,
                            client_secret: STRAVA_SECRET,
                            refresh_token: "1b149145afe921f17b74d81d0ff00f42b64cc217",
                            grant_type: 'refresh_token'
                        })
                    });
                    const data = await response.json();
                    if (data.access_token) {
                        setCurrentAccessToken(data.access_token);
                        return data.access_token;
                    }
                } catch (e) {
                    console.error("Error al refrescar token", e);
                }
                return null;
            };

            const syncStrava = async (tokenOverride = null) => {
                if (!user) return;
                setIsSyncing(true);
                const token = tokenOverride || currentAccessToken;
                
                try {
                    const res = await fetch(`https://www.strava.com/api/v3/athlete/activities?per_page=5`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (res.status === 401) {
                        showStatus("Token caducado. Intentando autorregulación...");
                        const newToken = await refreshAccessToken();
                        if (newToken) {
                            return syncStrava(newToken); // Reintento con el nuevo token
                        } else {
                            throw new Error("Relink required");
                        }
                    }

                    const data = await res.json();
                    let added = 0;
                    for (const act of data) {
                        if (!history.find(h => h.stravaId === act.id)) {
                            await addDoc(collection(db, "artifacts", "gestordeportes-36ba3", "users", user.uid, "history"), {
                                name: act.name,
                                type: act.type,
                                stravaId: act.id,
                                distance: (act.distance / 1000).toFixed(2),
                                duration: Math.floor(act.moving_time / 60),
                                timestamp: serverTimestamp(),
                                source: 'Apple Watch'
                            });
                            added++;
                        }
                    }
                    showStatus(added > 0 ? `Éxito: ${added} nuevas actividades` : "Sincronizado: Sin datos nuevos");
                } catch (e) {
                    showStatus("Error crítico. Re-vincula Strava en el panel.");
                } finally {
                    setIsSyncing(false);
                }
            };

            return (
                <div className="max-w-md mx-auto min-h-screen bg-black pb-32">
                    {status && (
                        <div className="fixed top-8 left-6 right-6 z-[100] glass px-6 py-4 rounded-3xl border-blue-500/30 flex items-center gap-3 animate-in fade-in slide-in-from-top-4">
                            <Icon name="info" size={16} className="text-blue-400" />
                            <p className="text-[10px] font-black uppercase tracking-widest leading-tight">{status}</p>
                        </div>
                    )}

                    <header className="p-8 border-b border-white/5 flex justify-between items-end sticky top-0 bg-black/90 backdrop-blur-xl z-40">
                        <h1 className="text-3xl font-black italic tracking-tighter uppercase">Omni<span className="text-blue-500">Forge</span></h1>
                        <div className="text-[10px] font-black text-emerald-500 flex items-center gap-1">
                            <div className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></div>
                            LINK READY
                        </div>
                    </header>

                    <main className="p-6 space-y-8">
                        <section className="glass neo-card p-8 border-orange-500/20 shadow-2xl relative overflow-hidden">
                            <div className="relative z-10">
                                <div className="flex gap-4 mb-6">
                                    <div className="p-4 bg-[#FC4C02] rounded-2xl text-white">
                                        <Icon name="watch" size={28} />
                                    </div>
                                    <div>
                                        <h3 className="font-black italic text-sm uppercase">Strava Bridge</h3>
                                        <p className="text-[10px] text-zinc-500 font-bold uppercase mt-1">Sincronización Inteligente</p>
                                    </div>
                                </div>
                                <button 
                                    onClick={() => syncStrava()}
                                    disabled={isSyncing}
                                    className="w-full py-5 bg-white text-black rounded-3xl font-black text-[11px] uppercase tracking-widest flex items-center justify-center gap-3 active:scale-95 transition-all"
                                >
                                    {isSyncing ? <Icon name="rotate-cw" className="animate-spin" /> : <Icon name="refresh-cw" size={16} />}
                                    Sincronizar Apple Watch
                                </button>
                            </div>
                        </section>

                        <section className="space-y-4">
                            <h3 className="text-[10px] font-black uppercase text-zinc-600 tracking-[0.3em] italic px-2">Timeline</h3>
                            {history.length === 0 ? (
                                <div className="p-20 text-center text-zinc-800 border-2 border-dashed border-zinc-900 rounded-[2.5rem]">
                                    <p className="text-[10px] font-black uppercase tracking-widest opacity-40 italic">Esperando datos...</p>
                                </div>
                            ) : (
                                history.map((w) => (
                                    <div key={w.id} className="glass p-5 rounded-[2rem] flex items-center justify-between group border border-transparent hover:border-blue-500/20 transition-all">
                                        <div className="flex items-center gap-5">
                                            <div className="p-4 rounded-2xl bg-blue-500/10 text-blue-400">
                                                <Icon name={w.type === 'Run' ? 'zap' : 'activity'} size={24} />
                                            </div>
                                            <div>
                                                <p className="font-black italic uppercase text-sm tracking-tight">{w.name}</p>
                                                <p className="text-[10px] font-black text-blue-500/60 mt-1 uppercase">
                                                    {w.distance} KM • {w.duration} MIN
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </section>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
