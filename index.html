<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OmniForge | Performance OS</title>
    <!-- Frameworks & Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- PropTypes es REQUERIDO para la versi√≥n UMD de Recharts -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@500&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #000; color: #fff; margin: 0; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(18, 18, 20, 0.9); backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .neo-card { border-radius: 2.5rem; }
        .strava-orange { background-color: #FC4C02; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .tab-active { background: white; color: black; box-shadow: 0 10px 20px rgba(255,255,255,0.1); }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide { animation: slideUp 0.4s ease-out forwards; }
        .hide-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        const { useState, useEffect, useMemo } = React;
        const { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = window.Recharts;

        const CONFIG = {
            firebase: {
                apiKey: "AIzaSyDCGa57RlWlZTvKBGmAL5NbjCfl4tKHbcw",
                authDomain: "gestordeportes-36ba3.firebaseapp.com",
                projectId: "gestordeportes-36ba3",
                storageBucket: "gestordeportes-36ba3.firebasestorage.app",
                messagingSenderId: "774570456776",
                appId: "1:774570456776:web:b0e1d2df541e0207aa97fd"
            },
            strava: {
                clientId: "205740",
                clientSecret: "b6c84aa920c3173ceacd33b568b85c99b7c07bb7"
            }
        };

        const app = initializeApp(CONFIG.firebase);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        // --- Utilidades ---
        const isCardio = (type) => ['Run', 'Ride', 'Walk', 'Hike', 'Swim', 'Workout'].includes(type);
        const formatDate = (dateStr) => {
            if (!dateStr) return 'Desconocido';
            const d = new Date(dateStr);
            return d.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' });
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [history, setHistory] = useState([]);
            const [activeTab, setActiveTab] = useState('hub');
            const [status, setStatus] = useState(null);
            const [isSyncing, setIsSyncing] = useState(false);
            const [errorCount, setErrorCount] = useState(0);
            
            // Estados para Calendario y Detalles
            const [selectedDate, setSelectedDate] = useState(null);
            const [selectedActivity, setSelectedActivity] = useState(null);
            // A√±adido control de mes para el calendario
            const [calendarMonth, setCalendarMonth] = useState(new Date());

            const [session, setSession] = useState(() => {
                const saved = localStorage.getItem('strava_session');
                return saved ? JSON.parse(saved) : null;
            });

            useEffect(() => {
                signInAnonymously(auth);
                const unsubAuth = onAuthStateChanged(auth, setUser);

                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                if (code) exchangeOAuthCode(code);

                return () => unsubAuth();
            }, []);

            useEffect(() => {
                if (!user) return;
                const path = collection(db, "artifacts", "gestordeportes-36ba3", "users", user.uid, "history");
                return onSnapshot(path, (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    // Ordenamos por startDate (la fecha real de la actividad) o timestamp si no existe
                    setHistory(data.sort((a,b) => {
                        const dateA = a.startDate ? new Date(a.startDate).getTime() : (a.timestamp?.seconds || 0) * 1000;
                        const dateB = b.startDate ? new Date(b.startDate).getTime() : (b.timestamp?.seconds || 0) * 1000;
                        return dateB - dateA;
                    }));
                });
            }, [user]);

            const showStatus = (msg) => {
                setStatus(msg);
                setTimeout(() => setStatus(null), 6000);
            };

            const exchangeOAuthCode = async (code) => {
                setIsSyncing(true);
                try {
                    const res = await fetch('https://www.strava.com/oauth/token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            client_id: CONFIG.strava.clientId,
                            client_secret: CONFIG.strava.clientSecret,
                            code: code,
                            grant_type: 'authorization_code'
                        })
                    });
                    const data = await res.json();
                    if (data.access_token) {
                        localStorage.setItem('strava_session', JSON.stringify(data));
                        setSession(data);
                        showStatus("‚úÖ Autenticaci√≥n validada. Sincronizando...");
                        window.history.replaceState({}, document.title, window.location.pathname);
                        syncWatch(data.access_token); 
                    }
                } catch (e) { showStatus("‚ùå Error en el intercambio de tokens."); }
                finally { setIsSyncing(false); }
            };

            const refreshStravaToken = async () => {
                if (!session?.refresh_token) return null;
                try {
                    const res = await fetch('https://www.strava.com/oauth/token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            client_id: CONFIG.strava.clientId,
                            client_secret: CONFIG.strava.clientSecret,
                            refresh_token: session.refresh_token,
                            grant_type: 'refresh_token'
                        })
                    });
                    const data = await res.json();
                    if (data.access_token) {
                        const newSession = { ...session, access_token: data.access_token, refresh_token: data.refresh_token };
                        localStorage.setItem('strava_session', JSON.stringify(newSession));
                        setSession(newSession);
                        return data.access_token;
                    }
                } catch (e) { console.error("Refresh failed", e); }
                return null;
            };

            const linkAccount = () => {
                const redirect = window.location.href.split('?')[0];
                // Forzamos la solicitud expl√≠cita de lectura de datos privados (activity:read_all)
                window.location.href = `https://www.strava.com/oauth/authorize?client_id=${CONFIG.strava.clientId}&response_type=code&redirect_uri=${redirect}&approval_prompt=force&scope=read,activity:read_all`;
            };

            const syncWatch = async (tokenOverride = null) => {
                if (!user || isSyncing) return;
                if (!session && !tokenOverride) {
                    linkAccount();
                    return;
                }

                if (errorCount > 2) {
                    showStatus("‚ö†Ô∏è Demasiados intentos. Espera 15 min o usa el bot√≥n Re-vincular.");
                    return;
                }

                setIsSyncing(true);
                showStatus("‚è≥ Solicitando 100 √∫ltimas actividades..."); // Aumentado a 100

                try {
                    let currentToken = tokenOverride || session.access_token;
                    let res = await fetch('https://www.strava.com/api/v3/athlete/activities?per_page=100', {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    });

                    if (res.status === 401) {
                        const newToken = await refreshStravaToken();
                        if (!newToken) {
                            showStatus("‚ùå Sesi√≥n expirada. Por favor, pulsa en el bot√≥n de la cadena para re-vincular.");
                            setSession(null);
                            localStorage.removeItem('strava_session');
                            setErrorCount(prev => prev + 1);
                            setIsSyncing(false);
                            return;
                        }
                        res = await fetch('https://www.strava.com/api/v3/athlete/activities?per_page=100', {
                            headers: { 'Authorization': `Bearer ${newToken}` }
                        });
                    }

                    if (res.status === 401) {
                        setSession(null);
                        localStorage.removeItem('strava_session');
                        throw new Error("SCOPE_INSUFFICIENT");
                    }
                    if (res.status === 429) {
                        showStatus("üö® L√≠mite de la API de Strava alcanzado. Vuelve en 15 minutos.");
                        setErrorCount(5);
                        setIsSyncing(false);
                        return;
                    }

                    const data = await res.json();
                    if (!Array.isArray(data)) throw new Error(data.message || "Formato de datos no v√°lido");

                    let added = 0;
                    for (const act of data) {
                        if (!history.find(h => h.stravaId === act.id)) {
                            
                            // C√°lculos avanzados de ritmo para carreras/caminatas
                            let paceStr = null;
                            if (act.average_speed > 0 && ['Run', 'Walk'].includes(act.type)) {
                                const paceSecs = 1000 / act.average_speed;
                                const paceMins = Math.floor(paceSecs / 60);
                                const paceRem = Math.floor(paceSecs % 60).toString().padStart(2, '0');
                                paceStr = `${paceMins}:${paceRem}`;
                            }

                            await addDoc(collection(db, "artifacts", "gestordeportes-36ba3", "users", user.uid, "history"), {
                                name: act.name,
                                type: act.type,
                                stravaId: act.id,
                                distance: (act.distance / 1000).toFixed(2), // km
                                duration: Math.floor(act.moving_time / 60), // min
                                calories: act.kilojoules ? Math.floor(act.kilojoules * 0.239) : 0,
                                startDate: act.start_date_local, // Fecha real del entreno local
                                heartrate: Math.round(act.average_heartrate || 0),
                                elevation: Math.round(act.total_elevation_gain || 0),
                                pace: paceStr,
                                timestamp: serverTimestamp(),
                                source: 'Apple Watch'
                            });
                            added++;
                        }
                    }
                    setErrorCount(0);
                    showStatus(added > 0 ? `üî• ${added} nuevas actividades extra√≠das (incluidas pasadas)!` : "‚úÖ Base de datos al d√≠a con Strava.");
                } catch (e) {
                    setErrorCount(prev => prev + 1);
                    if (e.message === "SCOPE_INSUFFICIENT") {
                        showStatus("‚ùå Strava bloque√≥ el acceso. MARCA la casilla 'Ver datos de actividades privadas' al vincular.");
                    } else {
                        showStatus("‚ùå Error de comunicaci√≥n con los servidores de Strava.");
                    }
                } finally {
                    setIsSyncing(false);
                }
            };

            const stats = useMemo(() => {
                const now = new Date();
                const last7Days = history.filter(h => {
                    const date = h.startDate ? new Date(h.startDate) : new Date(h.timestamp?.seconds * 1000);
                    return (now - date) / (1000 * 60 * 60 * 24) <= 7;
                });

                const chartData = last7Days.reverse().map(h => ({
                    name: h.startDate ? new Date(h.startDate).toLocaleDateString('es-ES', {weekday: 'short'}) : 'Hoy',
                    duracion: parseInt(h.duration) || 0
                }));

                return {
                    totalKms: history.reduce((acc, h) => acc + (parseFloat(h.distance) || 0), 0).toFixed(1),
                    gymSessions: history.filter(h => !isCardio(h.type)).length,
                    cardioSessions: history.filter(h => isCardio(h.type)).length,
                    chartData
                };
            }, [history]);

            // --- VISTAS DE PESTA√ëAS ---
            const renderHub = () => (
                <div className="space-y-6 animate-slide">
                    <section className="glass p-8 rounded-[2.5rem] border-blue-500/20 shadow-2xl overflow-hidden relative">
                        <div className="absolute top-0 right-0 p-6 opacity-10">
                            <Icon name="zap" size={120} />
                        </div>
                        <div className="relative z-10">
                            <h3 className="text-[10px] font-black uppercase text-zinc-500 tracking-widest italic mb-6">Carga Hist√≥rica Total</h3>
                            <div className="flex items-end gap-2 mb-2">
                                <span className="text-6xl font-black italic tracking-tighter leading-none">{stats.totalKms}</span>
                                <span className="text-sm font-bold text-blue-500 uppercase tracking-widest pb-1">Kms</span>
                            </div>
                            <div className="w-full bg-white/5 h-2 rounded-full overflow-hidden mt-4">
                                <div className="bg-blue-600 h-full w-[70%]" style={{boxShadow: '0 0 15px #3b82f6'}}></div>
                            </div>
                        </div>
                    </section>

                    <div className="grid grid-cols-2 gap-4">
                        <div className="glass p-6 rounded-[2rem] border-orange-500/20">
                            <Icon name="flame" className="text-orange-500 mb-3" />
                            <p className="text-3xl font-black italic tracking-tighter leading-none">{stats.cardioSessions}</p>
                            <p className="text-[9px] text-zinc-500 font-black uppercase mt-2">Cardio (Total)</p>
                        </div>
                        <div className="glass p-6 rounded-[2rem] border-purple-500/20">
                            <Icon name="dumbbell" className="text-purple-500 mb-3" />
                            <p className="text-3xl font-black italic tracking-tighter leading-none">{stats.gymSessions}</p>
                            <p className="text-[9px] text-zinc-500 font-black uppercase mt-2">Fuerza (Total)</p>
                        </div>
                    </div>

                    <section className="space-y-4">
                        <div className="flex justify-between items-center px-2">
                            <h3 className="text-[10px] font-black uppercase text-zinc-600 tracking-[0.4em] italic">√öltimas 3 Sesiones</h3>
                        </div>
                        <div className="space-y-3">
                            {history.slice(0, 3).map((w) => (
                                <div key={w.id} onClick={() => setSelectedActivity(w)} className="glass p-5 rounded-[2.2rem] flex items-center justify-between border-transparent hover:border-white/10 transition-all cursor-pointer">
                                    <div className="flex items-center gap-4">
                                        <div className={`p-3 rounded-2xl ${!isCardio(w.type) ? 'bg-purple-500/10 text-purple-500' : 'bg-blue-500/10 text-blue-500'}`}>
                                            <Icon name={!isCardio(w.type) ? 'dumbbell' : 'zap'} size={20} />
                                        </div>
                                        <div>
                                            <p className="font-black italic uppercase text-sm tracking-tighter leading-none mb-1">{w.name}</p>
                                            <p className="text-[9px] font-bold text-zinc-600 uppercase">
                                                {formatDate(w.startDate)}
                                            </p>
                                        </div>
                                    </div>
                                    <Icon name="chevron-right" size={14} className="text-zinc-800" />
                                </div>
                            ))}
                        </div>
                    </section>
                </div>
            );

            const renderActivities = () => {
                // Calendario ajustado para navegar entre meses
                const monthDays = Array.from({length: new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() + 1, 0).getDate()}, (_, i) => i + 1);
                
                const prevMonth = () => setCalendarMonth(new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() - 1, 1));
                const nextMonth = () => setCalendarMonth(new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() + 1, 1));

                const getActivitiesForDay = (day) => {
                    return history.filter(h => {
                        if(!h.startDate) return false;
                        const d = new Date(h.startDate);
                        return d.getDate() === day && d.getMonth() === calendarMonth.getMonth() && d.getFullYear() === calendarMonth.getFullYear();
                    });
                };

                const filteredHistory = selectedDate 
                    ? history.filter(h => h.startDate && new Date(h.startDate).getDate() === selectedDate && new Date(h.startDate).getMonth() === calendarMonth.getMonth())
                    : history.filter(h => h.startDate && new Date(h.startDate).getMonth() === calendarMonth.getMonth() && new Date(h.startDate).getFullYear() === calendarMonth.getFullYear());

                return (
                    <div className="space-y-6 animate-slide">
                        <div className="px-2 flex justify-between items-end">
                            <div>
                                <h2 className="text-3xl font-black italic tracking-tighter uppercase">Explorador</h2>
                                <p className="text-[10px] text-zinc-500 font-bold uppercase tracking-widest mt-1">
                                    Base de datos inteligente
                                </p>
                            </div>
                        </div>

                        {/* Controles de Calendario */}
                        <div className="glass p-5 rounded-[2rem] border-white/5 space-y-4">
                            <div className="flex justify-between items-center px-2">
                                <button onClick={prevMonth} className="text-zinc-500 hover:text-white"><Icon name="chevron-left" size={18}/></button>
                                <span className="font-black text-sm uppercase tracking-widest text-blue-400">
                                    {calendarMonth.toLocaleDateString('es-ES', {month: 'long', year: 'numeric'})}
                                </span>
                                <button onClick={nextMonth} className="text-zinc-500 hover:text-white"><Icon name="chevron-right" size={18}/></button>
                            </div>
                            
                            <div className="grid grid-cols-7 gap-2 text-center">
                                {['L','M','X','J','V','S','D'].map(d => <div key={d} className="text-[8px] font-black text-zinc-600">{d}</div>)}
                                {monthDays.map(day => {
                                    const acts = getActivitiesForDay(day);
                                    const hasActivity = acts.length > 0;
                                    const isSelected = selectedDate === day;
                                    const isGym = acts.some(a => !isCardio(a.type));
                                    
                                    return (
                                        <button 
                                            key={day}
                                            onClick={() => setSelectedDate(isSelected ? null : day)}
                                            className={`aspect-square rounded-full flex items-center justify-center text-xs font-bold transition-all ${
                                                isSelected ? 'bg-white text-black scale-110' : 
                                                hasActivity ? (isGym ? 'bg-purple-500/20 text-purple-400 border border-purple-500/30' : 'bg-blue-500/20 text-blue-400 border border-blue-500/30') : 'text-zinc-700 hover:bg-white/5'
                                            }`}
                                        >
                                            {day}
                                        </button>
                                    );
                                })}
                            </div>
                            {selectedDate && (
                                <button onClick={() => setSelectedDate(null)} className="w-full py-2 text-[9px] font-black text-zinc-500 uppercase hover:text-white transition-colors">
                                    Limpiar Filtro (Ver todo el mes)
                                </button>
                            )}
                        </div>

                        <div className="space-y-3 pb-6">
                            {filteredHistory.length === 0 ? (
                                <div className="p-10 text-center text-zinc-600 text-xs italic">No hay registros para las fechas seleccionadas.</div>
                            ) : (
                                filteredHistory.map((w) => (
                                    <div key={w.id} onClick={() => setSelectedActivity(w)} className="glass p-6 rounded-[2.5rem] border-white/5 space-y-4 cursor-pointer hover:border-white/20 transition-all">
                                        <div className="flex justify-between items-start">
                                            <div className="flex gap-4 items-center">
                                                <div className={`p-3 bg-white/5 rounded-2xl ${!isCardio(w.type) ? 'text-purple-400' : 'text-blue-400'}`}>
                                                    <Icon name={!isCardio(w.type) ? 'dumbbell' : 'zap'} size={20} />
                                                </div>
                                                <div>
                                                    <p className="font-black italic uppercase text-sm">{w.name}</p>
                                                    <p className="text-[9px] text-zinc-500 font-bold uppercase">{formatDate(w.startDate)}</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="grid grid-cols-3 gap-2 border-t border-white/5 pt-4">
                                            <div className="text-center">
                                                <p className="text-[8px] text-zinc-600 font-black uppercase mb-1">Tiempo</p>
                                                <p className="text-sm font-black italic font-mono">{w.duration || '--'} <span className="text-[8px]">m</span></p>
                                            </div>
                                            <div className="text-center">
                                                <p className="text-[8px] text-zinc-600 font-black uppercase mb-1">Distancia</p>
                                                <p className="text-sm font-black italic font-mono text-blue-400">{w.distance || '0.0'} <span className="text-[8px]">km</span></p>
                                            </div>
                                            <div className="text-center">
                                                <p className="text-[8px] text-zinc-600 font-black uppercase mb-1">Calor√≠as</p>
                                                <p className="text-sm font-black italic font-mono text-orange-400">{w.calories || '--'}</p>
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                );
            };

            const renderStats = () => (
                <div className="space-y-6 animate-slide">
                    <div className="px-2">
                        <h2 className="text-3xl font-black italic tracking-tighter uppercase leading-none">An√°lisis</h2>
                        <p className="text-[10px] text-zinc-500 font-bold uppercase tracking-widest mt-2">Carga de Trabajo √öltimos 7 D√≠as</p>
                    </div>

                    <section className="glass p-6 rounded-[2.5rem] border-white/5 h-64">
                        <ResponsiveContainer width="100%" height="100%">
                            <AreaChart data={stats.chartData}>
                                <defs>
                                    <linearGradient id="colorDur" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.4}/>
                                        <stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/>
                                    </linearGradient>
                                </defs>
                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="rgba(255,255,255,0.05)" />
                                <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fill: '#666', fontSize: 10, fontWeight: 'bold'}} />
                                <Tooltip 
                                    contentStyle={{backgroundColor: '#111', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '16px', fontSize: '12px', fontWeight: 'bold'}}
                                    itemStyle={{color: '#3b82f6'}}
                                />
                                <Area type="monotone" dataKey="duracion" stroke="#3b82f6" fillOpacity={1} fill="url(#colorDur)" strokeWidth={4} />
                            </AreaChart>
                        </ResponsiveContainer>
                    </section>
                </div>
            );

            // Modal de Detalles de Actividad
            const renderModal = () => {
                if (!selectedActivity) return null;
                const w = selectedActivity;
                const isGym = !isCardio(w.type);
                
                return (
                    <div className="fixed inset-0 z-[200] bg-black/95 backdrop-blur-xl p-6 flex flex-col justify-end pb-32 animate-in fade-in duration-300">
                        <div className="glass p-8 rounded-[3rem] border-white/10 w-full max-w-md mx-auto relative shadow-2xl">
                            <button 
                                onClick={() => setSelectedActivity(null)}
                                className="absolute top-6 right-6 p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors"
                            >
                                <Icon name="x" size={18} />
                            </button>
                            
                            <div className="flex items-center gap-4 mb-8">
                                <div className={`p-4 rounded-3xl ${isGym ? 'bg-purple-500/20 text-purple-400' : 'bg-blue-500/20 text-blue-500'}`}>
                                    <Icon name={isGym ? 'dumbbell' : 'zap'} size={32} />
                                </div>
                                <div>
                                    <h2 className="text-xl font-black italic uppercase leading-tight pr-8">{w.name}</h2>
                                    <p className="text-[10px] text-zinc-400 font-bold uppercase mt-1">{formatDate(w.startDate)}</p>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4 mb-6">
                                <div className="bg-black/50 p-5 rounded-3xl border border-white/5">
                                    <Icon name="timer" size={16} className="text-zinc-500 mb-2" />
                                    <p className="text-2xl font-black italic font-mono leading-none">{w.duration}</p>
                                    <p className="text-[8px] text-zinc-500 font-black uppercase mt-1">Minutos</p>
                                </div>
                                {!isGym && (
                                    <div className="bg-black/50 p-5 rounded-3xl border border-white/5">
                                        <Icon name="map-pin" size={16} className="text-blue-500 mb-2" />
                                        <p className="text-2xl font-black italic font-mono text-blue-400 leading-none">{w.distance || '0'}</p>
                                        <p className="text-[8px] text-zinc-500 font-black uppercase mt-1">Kil√≥metros</p>
                                    </div>
                                )}
                                <div className="bg-black/50 p-5 rounded-3xl border border-white/5">
                                    <Icon name="heart" size={16} className="text-red-500 mb-2" />
                                    <p className="text-2xl font-black italic font-mono text-red-400 leading-none">{w.heartrate || '--'}</p>
                                    <p className="text-[8px] text-zinc-500 font-black uppercase mt-1">BPM Medio</p>
                                </div>
                                {!isGym && (
                                    <div className="bg-black/50 p-5 rounded-3xl border border-white/5">
                                        <Icon name="zap" size={16} className="text-orange-500 mb-2" />
                                        <p className="text-2xl font-black italic font-mono text-orange-400 leading-none">{w.pace || '--'}</p>
                                        <p className="text-[8px] text-zinc-500 font-black uppercase mt-1">Ritmo (Min/Km)</p>
                                    </div>
                                )}
                                <div className={`bg-black/50 p-5 rounded-3xl border border-white/5 flex justify-between items-center ${isGym ? 'col-span-2' : 'col-span-2'}`}>
                                    <div>
                                        <p className="text-[10px] text-zinc-500 font-black uppercase mb-1">{isGym ? 'Calor√≠as Activas' : 'Desnivel Positivo'}</p>
                                        <p className="text-xl font-black italic font-mono text-emerald-400 leading-none">
                                            {isGym ? `${w.calories || '0'} kcal` : `+${w.elevation || '0'}m`}
                                        </p>
                                    </div>
                                    <Icon name={isGym ? "flame" : "mountain"} size={24} className="text-emerald-500/50" />
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="max-w-md mx-auto min-h-screen bg-black pb-32 hide-scroll overflow-y-auto">
                    {status && (
                        <div className="fixed top-10 left-6 right-6 z-[100] glass p-5 rounded-3xl border-white/10 text-center animate-in fade-in slide-in-from-top-4 shadow-2xl">
                            <p className="text-[10px] font-black uppercase tracking-[0.2em] text-blue-400">{status}</p>
                        </div>
                    )}

                    <header className="p-8 border-b border-white/5 sticky top-0 bg-black/90 backdrop-blur-xl z-50 flex justify-between items-center">
                        <div>
                            <h1 className="text-2xl font-black italic tracking-tighter uppercase leading-none">Omni<span className="text-blue-500">Forge</span></h1>
                            <p className="text-[8px] text-zinc-600 font-bold uppercase tracking-[0.3em] mt-1">Intelligence Module</p>
                        </div>
                        
                        <div className="flex items-center gap-3">
                            <button 
                                onClick={linkAccount}
                                className="p-2 rounded-xl bg-zinc-900 border border-white/5 text-zinc-500 hover:text-white transition-all active:scale-90"
                                title="Re-vincular Strava (Para arreglar permisos)"
                            >
                                <Icon name="link" size={16} />
                            </button>
                            <button 
                                onClick={() => session ? syncWatch() : linkAccount()}
                                disabled={isSyncing}
                                className={`p-3 rounded-2xl bg-zinc-900 border border-white/5 transition-all active:scale-90 ${isSyncing ? 'animate-spin text-blue-400' : 'text-blue-500 hover:bg-blue-500/10'}`}
                            >
                                <Icon name="refresh-cw" size={18} />
                            </button>
                        </div>
                    </header>

                    <main className="p-6">
                        {activeTab === 'hub' && renderHub()}
                        {activeTab === 'activities' && renderActivities()}
                        {activeTab === 'stats' && renderStats()}
                    </main>

                    {renderModal()}

                    <nav className="fixed bottom-10 left-8 right-8 z-50">
                        <div className="glass rounded-[3rem] p-2 flex justify-around shadow-2xl border-white/10">
                            {[
                                { id: 'hub', icon: 'activity', label: 'Dashboard' },
                                { id: 'activities', icon: 'layers', label: 'Historial' },
                                { id: 'stats', icon: 'bar-chart-3', label: 'An√°lisis' }
                            ].map((t) => (
                                <button 
                                    key={t.id} 
                                    onClick={() => setActiveTab(t.id)}
                                    className={`flex-1 py-4 flex flex-col items-center rounded-[2rem] transition-all duration-300 ${activeTab === t.id ? 'tab-active' : 'text-zinc-600 hover:text-white'}`}
                                >
                                    <Icon name={t.icon} size={20} />
                                    <span className="text-[7px] font-black uppercase mt-1 tracking-widest">{t.label}</span>
                                </button>
                            ))}
                        </div>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
