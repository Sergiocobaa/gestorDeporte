<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OmniForge | Precision Performance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@500&display=swap');
        :root { --strava: #FC4C02; --apex-blue: #3b82f6; }
        body { font-family: 'Inter', sans-serif; background-color: #000; color: #fff; margin: 0; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(20, 20, 23, 0.7); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .neo-card { border-radius: 2rem; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .hide-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Cambiado de type="module" a type="text/babel" con data-type="module" para que Babel procese el JSX e imports -->
    <script type="text/babel" data-type="module">
        // Importación de módulos Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        const { useState, useEffect, useMemo } = React;

        // --- CONFIGURACIÓN INTEGRADA ---
        const firebaseConfig = {
            apiKey: "AIzaSyDCGa57RlWlZTvKBGmAL5NbjCfl4tKHbcw",
            authDomain: "gestordeportes-36ba3.firebaseapp.com",
            projectId: "gestordeportes-36ba3",
            storageBucket: "gestordeportes-36ba3.firebasestorage.app",
            messagingSenderId: "774570456776",
            appId: "1:774570456776:web:b0e1d2df541e0207aa97fd"
        };

        const STRAVA_AUTH = {
            accessToken: "06ee57d24b4323ae084f327d3760e683d7d02cfe",
            clientSecret: "b6c84aa920c3173ceacd33b568b85c99b7c07bb7",
            refreshToken: "1b149145afe921f17b74d81d0ff00f42b64cc217"
        };

        const appId = "gestordeportes-36ba3";

        // Inicialización de servicios
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Helper para Iconos Lucide
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('hub');
            const [history, setHistory] = useState([]);
            const [status, setStatus] = useState(null);
            const [isSyncing, setIsSyncing] = useState(false);

            // Métrica única simulada: Índice de Eficiencia Bio-Mecánica
            const efficiencyScore = useMemo(() => {
                if (history.length === 0) return 0;
                // Generar un número estable basado en la longitud de la historia para evitar cambios en cada render
                return 85 + (history.length % 11);
            }, [history]);

            // Fase 1: Autenticación
            useEffect(() => {
                signInAnonymously(auth).catch(console.error);
                const unsubAuth = onAuthStateChanged(auth, setUser);
                return () => unsubAuth();
            }, []);

            // Fase 2: Escucha de datos
            useEffect(() => {
                if (!user) return;
                const path = collection(db, "artifacts", appId, "users", user.uid, "history");
                const unsubSnap = onSnapshot(path, (snapshot) => {
                    const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    setHistory(data.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)));
                }, (err) => {
                    console.error("Firestore error:", err);
                    showStatus("Error de permisos en Firestore");
                });
                return () => unsubSnap();
            }, [user]);

            const showStatus = (msg) => {
                setStatus(msg);
                setTimeout(() => setStatus(null), 5000);
            };

            // Sincronización Real con Apple Watch vía Strava
            const syncAppleWatch = async () => {
                if (!user) return;
                setIsSyncing(true);
                showStatus("Conectando con Apple Watch Cloud...");

                try {
                    const response = await fetch('https://www.strava.com/api/v3/athlete/activities?per_page=5', {
                        headers: { 'Authorization': `Bearer ${STRAVA_AUTH.accessToken}` }
                    });

                    if (!response.ok) throw new Error("Token caducado");

                    const data = await response.json();
                    let news = 0;

                    for (const act of data) {
                        const exists = history.find(h => h.stravaId === act.id);
                        if (!exists) {
                            await addDoc(collection(db, "artifacts", appId, "users", user.uid, "history"), {
                                name: act.name,
                                type: act.type,
                                stravaId: act.id,
                                distance: (act.distance / 1000).toFixed(2),
                                duration: Math.floor(act.moving_time / 60),
                                calories: act.kilojoules ? Math.floor(act.kilojoules * 0.239) : 0,
                                timestamp: serverTimestamp(),
                                source: 'Apple Watch'
                            });
                            news++;
                        }
                    }
                    showStatus(news > 0 ? `Sincronizadas ${news} sesiones nuevas` : "Datos actualizados");
                } catch (e) {
                    showStatus("Token Expirado o Error de API.");
                } finally {
                    setIsSyncing(false);
                }
            };

            const addGymSet = async () => {
                if (!user) return;
                try {
                    await addDoc(collection(db, "artifacts", appId, "users", user.uid, "history"), {
                        name: "Sesión de Fuerza",
                        type: "Gym",
                        volume: "8,450 kg",
                        intensity: "88%",
                        timestamp: serverTimestamp(),
                        source: 'Manual Log'
                    });
                    showStatus("Log de fuerza guardado");
                } catch (e) { showStatus("Error al guardar en Firestore"); }
            };

            return (
                <div className="max-w-md mx-auto min-h-screen relative pb-32 bg-black overflow-hidden">
                    {status && (
                        <div className="fixed top-8 left-6 right-6 z-[100] glass px-6 py-4 rounded-3xl border-blue-500/30 flex items-center gap-3 animate-in fade-in slide-in-from-top-4">
                            <Icon name="info" className="text-blue-400" />
                            <p className="text-[10px] font-black uppercase tracking-widest leading-tight">{status}</p>
                        </div>
                    )}

                    <header className="p-8 border-b border-white/5 flex justify-between items-end sticky top-0 bg-black/80 backdrop-blur-xl z-40">
                        <div>
                            <h1 className="text-3xl font-black italic tracking-tighter uppercase italic">Omni<span className="text-blue-500">Forge</span></h1>
                            <p className="text-[8px] text-zinc-600 font-black tracking-[0.4em] uppercase mt-1">High Intensity OS</p>
                        </div>
                        <div className="text-right">
                             <div className="text-[10px] font-black text-emerald-500 flex items-center gap-1 justify-end">
                                <div className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></div>
                                LIVE SYNC
                             </div>
                             <p className="text-[8px] text-zinc-500 font-bold font-mono uppercase">ID: {user?.uid.substring(0,8)}</p>
                        </div>
                    </header>

                    <main className="p-6 space-y-8">
                        <section className="glass neo-card p-8 border-orange-500/20 shadow-[0_20px_40px_rgba(252,76,2,0.1)]">
                            <div className="flex justify-between items-start mb-6">
                                <div className="flex gap-4">
                                    <div className="p-4 bg-gradient-to-tr from-orange-600 to-orange-400 rounded-2xl shadow-lg text-white">
                                        <Icon name="watch" size={28} />
                                    </div>
                                    <div>
                                        <h3 className="font-black italic text-sm uppercase">Apple Watch Bridge</h3>
                                        <p className="text-[10px] text-zinc-500 font-bold uppercase mt-1">Sync via Strava Cloud</p>
                                    </div>
                                </div>
                                <Icon name="zap" className="text-orange-500" size={16} />
                            </div>

                            <div className="grid grid-cols-2 gap-3 mb-6">
                                <div className="bg-black/40 p-4 rounded-2xl border border-white/5">
                                    <p className="text-[8px] text-zinc-500 font-black uppercase mb-1">Status</p>
                                    <p className="text-xs font-black text-emerald-400 italic">CONNECTED</p>
                                </div>
                                <div className="bg-black/40 p-4 rounded-2xl border border-white/5">
                                    <p className="text-[8px] text-zinc-500 font-black uppercase mb-1">Efficiency</p>
                                    <p className="text-xs font-black italic">{efficiencyScore}%</p>
                                </div>
                            </div>

                            <button 
                                onClick={syncAppleWatch}
                                disabled={isSyncing}
                                className="w-full py-5 bg-white text-black rounded-[1.5rem] font-black text-[11px] uppercase tracking-widest flex items-center justify-center gap-3 transition-all active:scale-95 disabled:opacity-50"
                            >
                                {isSyncing ? <Icon name="rotate-cw" className="animate-spin" size={16} /> : <Icon name="refresh-cw" size={16} />}
                                Sincronizar Watch
                            </button>
                        </section>

                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-zinc-900/50 p-6 rounded-[2rem] border border-white/5">
                                <Icon name="flame" className="text-orange-500 mb-3" />
                                <p className="text-3xl font-black italic tracking-tighter">1.2k</p>
                                <p className="text-[9px] text-zinc-500 font-black uppercase">Metabolic Kcal</p>
                            </div>
                            <div className="bg-zinc-900/50 p-6 rounded-[2rem] border border-white/5">
                                <Icon name="dumbbell" className="text-blue-500 mb-3" />
                                <p className="text-3xl font-black italic tracking-tighter">{history.filter(h => h.type === 'Gym').length}</p>
                                <p className="text-[9px] text-zinc-500 font-black uppercase">Gym Sessions</p>
                            </div>
                        </div>

                        <section className="space-y-4">
                            <div className="flex justify-between items-center px-2">
                                <h3 className="text-[10px] font-black uppercase text-zinc-600 tracking-[0.3em] italic">Timeline Actividad</h3>
                                <button onClick={addGymSet} className="bg-blue-600 p-3 rounded-2xl shadow-xl shadow-blue-900/40 active:scale-90 transition-transform">
                                    <Icon name="plus" size={18} />
                                </button>
                            </div>

                            <div className="space-y-3">
                                {history.length === 0 ? (
                                    <div className="p-16 text-center text-zinc-800 border-2 border-dashed border-zinc-900 rounded-[2.5rem]">
                                        <p className="text-[10px] font-black uppercase tracking-widest italic opacity-40">No activity data found</p>
                                    </div>
                                ) : (
                                    history.map((w) => (
                                        <div key={w.id} className="glass p-5 rounded-[2rem] flex items-center justify-between group hover:border-blue-500/30 transition-all border border-transparent">
                                            <div className="flex items-center gap-5">
                                                <div className={`p-4 rounded-2xl ${w.type === 'Gym' ? 'bg-purple-500/10 text-purple-400' : 'bg-blue-500/10 text-blue-400'}`}>
                                                    <Icon name={w.type === 'Gym' ? 'dumbbell' : 'zap'} size={24} />
                                                </div>
                                                <div>
                                                    <p className="font-black italic uppercase text-sm tracking-tight">{w.name}</p>
                                                    <div className="flex items-center gap-2 mt-1">
                                                        <span className="text-[8px] bg-white/5 px-2 py-0.5 rounded text-zinc-500 font-black uppercase tracking-tighter">
                                                            {w.source}
                                                        </span >
                                                        <span className="text-[9px] text-zinc-700 font-mono">
                                                            {w.timestamp?.seconds ? new Date(w.timestamp.seconds * 1000).toLocaleDateString() : 'Syncing'}
                                                        </span>
                                                    </div>
                                                    {w.distance && (
                                                        <p className="text-[10px] font-black text-blue-400 mt-1 uppercase tracking-tighter font-mono">
                                                            {w.distance} KM • {w.duration} MIN
                                                        </p>
                                                    )}
                                                </div>
                                            </div>
                                            <Icon name="chevron-right" size={16} className="text-zinc-800 group-hover:text-zinc-500 transition-colors" />
                                        </div>
                                    ))
                                )}
                            </div>
                        </section>
                    </main>

                    <nav className="fixed bottom-10 left-8 right-8 z-50">
                        <div className="glass rounded-[3rem] p-2 flex justify-around shadow-2xl">
                            <button onClick={() => setActiveTab('hub')} className={`flex-1 py-5 rounded-[2.5rem] flex flex-col items-center transition-all duration-500 ${activeTab === 'hub' ? 'bg-white text-black shadow-xl scale-110' : 'text-zinc-500'}`}>
                                <Icon name="activity" size={24} />
                                <span className="text-[8px] font-black uppercase mt-2 tracking-widest">Hub</span>
                            </button>
                            <button onClick={() => setActiveTab('gym')} className={`flex-1 py-5 rounded-[2.5rem] flex flex-col items-center transition-all duration-500 ${activeTab === 'gym' ? 'bg-white text-black shadow-xl scale-110' : 'text-zinc-500'}`}>
                                <Icon name="dumbbell" size={24} />
                                <span className="text-[8px] font-black uppercase mt-2 tracking-widest">Gym</span>
                            </button>
                            <button onClick={() => setActiveTab('data')} className={`flex-1 py-5 rounded-[2.5rem] flex flex-col items-center transition-all duration-500 ${activeTab === 'data' ? 'bg-white text-black shadow-xl scale-110' : 'text-zinc-500'}`}>
                                <Icon name="bar-chart-3" size={24} />
                                <span className="text-[8px] font-black uppercase mt-2 tracking-widest">Data</span>
                            </button>
                        </div>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
